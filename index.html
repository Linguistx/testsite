<html>

<meta charset="UTF-8">
<link href="/theme/default.css" rel="stylesheet">

<body>
    <article>
        <div class="header">
            <span id="title"></span>
            <span class="searchbar">
                <span id="searchPart">
                    <input id="search-box-input" autocorrect="off" autocapitalize="off" spellcheck="false"></input>
                    <img onclick="javascript:searchWord()" id="magnifying-glass" src="/theme/magnifying-glass.svg" height="25px"></img>
                </span>
            </span>
        </div>
        <div class="navbar">
            <a href="#">Dictionary</a>
            <a href="#">Grammar</a>
            <a href="#">About</a>
        </div>
        <div class="row">
            <div class="side" id="sidebar"></div>
            <div class="main">
                <div id="entry"></div>
            </div>
        </div>
        <div class="footer">Footer placeholder</div>
    </article>
</body>

<script>
let url = document.location.href
let textFileLocation = document.location.origin + '/dictionary.txt'

let settings = {
    title : 'A Vulgar Online Dictionry',
    languageA : '',
    languageB : '',
    exonymA : '',
    exonymb : ''
 }
let partsOfSpeech = {} 
let dictionary = {}
let entriesOnly = []

let getTextFile = new XMLHttpRequest()
getTextFile.open('GET', textFileLocation, true)
getTextFile.send()
    
getTextFile.onreadystatechange = function() {
    if (getTextFile.readyState == 4 && getTextFile.status == 200) {
        
        let dictionaryBlob = getTextFile.responseText
        dictionaryBlob = dictionaryBlob.split(/--- *(SETTINGS|PARTS OF SPEECH|A TO B DICTIONARY|B TO A DICTIONARY)/g)

        let settingsText = dictionaryBlob[dictionaryBlob.indexOf('SETTINGS') + 1]
        let partsOfSpeechText = dictionaryBlob[dictionaryBlob.indexOf('PARTS OF SPEECH') + 1]
        let dictionaryA = dictionaryBlob[dictionaryBlob.indexOf('A TO B DICTIONARY') + 1]
        let dictionaryB = dictionaryBlob[dictionaryBlob.indexOf('B TO A DICTIONARY') + 1]
        
        settingsText = settingsText.split(/\n/g)
        for (let setting of settingsText) {
            setting = setting.trim()
            if (setting == '') continue
            setting = setting.split('=')
            let keySide = setting[0].trim()
            let valueSide = setting[1].trim()
            switch (keySide) {
                case 'Website title': settings.title = valueSide; break
                case 'Language A': settings.languageA = valueSide; break
                case 'Language B': settings.languageB = valueSide; break
                case 'Exonym A': settings.exonymA = valueSide; break
                case 'Exonym B': settings.exonymB = valueSide; break
            }            
        }
        document.getElementById('title').innerHTML = settings.title
        document.title = settings.title
        
        partsOfSpeechText = partsOfSpeechText.split('\n')
        for (let line of partsOfSpeechText) {
            line = line.trim()
            if (line == '' || !line.includes('=')) continue
            line = line.split('=')
            let keySide = line[0].trim()
            let valueSide = line[1].trim()
            partsOfSpeech[keySide] = valueSide
        }   
        
        dictionaryA = dictionaryA.split('@')
        for (let entry of dictionaryA) {
            let forwardSlash = entry.indexOf('/')
            let colon = entry.search(/\w+ *:/)
            let delineator = Math.min(forwardSlash, colon)
            delineator = (delineator > 0) ? delineator : Math.max(forwardSlash, colon)
            let word = entry.slice(0, delineator).trim()
            let wordData = entry.slice(delineator).trim()
            if (!dictionary[word]) {
                dictionary[word] = [wordData]
                entriesOnly.push(word)
            } else {
                dictionary[word].push(wordData)
            }
        }
        
        if (url.includes('?')) {
            var queryTerm = decodeURI(url.slice(url.indexOf('?') + 1))
            sendEntry(queryTerm, dictionary[queryTerm])
        } else {

        }
    }
}

function sendEntry(term, associatedInfo) {
	console.log(dictionary)
    let allEntries = []
    console.log(typeof associatedInfo, associatedInfo)
    for (let entry of associatedInfo) {
        let subheadings = []
        entry = entry.split(/(\w+ *:)/)
        let pronunciation = entry[0].trim()
        for (let i = 1; i < entry.length; i = i + 2) {
            let translations = []
            let subheading = entry[i].trim()
            console.log(4, subheading)
            if (subheading.search(/[A-Z]/) == 0) {
                let body = entry[i + 1]
		subheading = subheading.match(/^[A-Z]\w*/)[0]
                subheading = subheading.replace(/_/g, ' ')
                subheadings.push('<h2>' + subheading + '</h2><p>' + body)
            } else {
                let senses = entry[i + 1].split('#')
                var pos = senses[0].replace(/ *: */, '').trim()
                pos = partsOfSpeech[pos] || pos
                var translation = ''
                for (let j = 1; j < senses.length; j++) {
                    let sense = senses[j]
                    sense = sense.split('*')
                    var translation = '<li>' + sense[0].trim() + '</li>'
                    let quotes = ''
                    for (let k = 1; k < sense.length; k++) {
                        let quote = '<li>' + sense[k].trim() + '</li>'
                        if (quote.includes(' - ')) {
                            quote = quote.replace(' - ', ' â€” <span class="trans-quote">')
                            quote = quote.replace('</li>', '</span></li>')
                        }
                        quotes += quote
                    }
                    if (quotes != "") quotes = '<ul>' + quotes + '</ul>'
                        translation += quotes
	                translations.push(translation)
                }
                
                if (translation != []) translation = '<ol>' + translations.join("") + '</ol>'
                subheading = '<h3>' + pos + '</h3>' + translation
                subheadings.push(subheading)
            }
        }
        var final = '<h1>' + term + '</h1>' + '<p>' + pronunciation + '</p>' + subheadings.join('')
        allEntries.push(final)
    }
    document.getElementById('entry').innerHTML = allEntries.join('')

    let startIndex = entriesOnly.indexOf(term)
    if (startIndex < 10) startIndex = 10
    var sidebar = entriesOnly.slice(startIndex - 10 , startIndex + 11);
    sidebar = sidebar.map(i => `<li><a onclick="javascript:sendEntry('` + i + `', dictionary['` + i + `']);">` + i + '</a></li>')
    document.getElementById('sidebar').innerHTML = '<h3>More ...</h3><ul>' + sidebar.join('') + '</ul>'
}

function searchWord() {
    let queryTerm = document.getElementById('search-box-input').value.trim()
	sendEntry(queryTerm, dictionary[queryTerm])
    var stateObj = { foo: 'bar' }
    history.pushState(stateObj, queryTerm, '?' + queryTerm)
}

let input = document.getElementById('search-box-input')
input.addEventListener('keyup', function(event) {
    if (event.keyCode === 13) {
        event.preventDefault()
        document.getElementById('magnifying-glass').click()
    }
})
   
</script>
    
</html>
