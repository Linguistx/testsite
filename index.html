<html>

<meta charset="UTF-8">
<link href="/theme/default.css" rel="stylesheet">

<body>
    <article>
        <div class="header">
            <span class="title"></span>
            <span class="searchbar">
                <span id="searchPart">
                    <input id="search-box-input" autocorrect="off" autocapitalize="off" spellcheck="false"></input>
                    <img onclick="javascript:searchWord()" id="magnifying-glass" src="/theme/magnifying-glass.svg" height="25px"></img>
                </span>
            </span>
        </div>
        <div class="navbar">
            <a href="#">Dictionary</a>
            <a href="#">Grammar</a>
            <a href="#">About</a>
        </div>
        <div class="row">
            <div class="side"></div>
            <div class="main">
                <div id="entry"></div>
            </div>
        </div>
        <div class="footer">Powered by Vulgarlang.com</div>
    </article>
</body>

<script>
let url = document.location.href
let textFileLocation = document.location.origin + '/dictionary.txt'

let settings = {
    title : '',
    languageA : '',
    languageB : '',
    exonymA : '',
    exonymb : ''
 }
let partsOfSpeech = {} 
let dictionary = {}

let getTextFile = new XMLHttpRequest()
getTextFile.open('GET', textFileLocation, true)
getTextFile.send()
    
getTextFile.onreadystatechange = function() {
    console.log('readyState', getTextFile.readyState)
    if (getTextFile.readyState == 4 && getTextFile.status == 200) {
        
        let dictionaryBlob = getTextFile.responseText
        dictionaryBlob = dictionaryBlob.split(/--(SETTINGS|PARTS OF SPEECH|A TO B DICTIONARY|B TO A DICTIONARY)--/g)

        let settingsText = dictionaryBlob[dictionaryBlob.indexOf('SETTINGS') + 1]
        let partsOfSpeechText = dictionaryBlob[dictionaryBlob.indexOf('PARTS OF SPEECH') + 1]
        let dictionaryA = dictionaryBlob[dictionaryBlob.indexOf('A TO B DICTIONARY') + 1]
        let dictionaryB = dictionaryBlob[dictionaryBlob.indexOf('B TO A DICTIONARY') + 1]
        
        settingsText = settingsText.split(/\n/g)
        for (let setting of settingsText) {
            setting = setting.trim()
            if (setting == '') continue
            setting = setting.split('=')
            let keySide = setting[0].trim()
            let valueSide = setting[1].trim()
            switch (keySide) {
                case 'Website title': settings.title = valueSide; break
                case 'Language A': settings.languageA = valueSide; break
                case 'Language B': settings.languageB = valueSide; break
                case 'Exonym A': settings.exonymA = valueSide; break
                case 'Exonym B': settings.exonymB = valueSide; break
            }            
        }

        dictionaryA = dictionaryA.split('@')
        for (let entry of dictionaryA) {
            let forwardSlash = entry.indexOf('/')
            let colon = entry.indexOf(':')
            let delineator = Math.min(forwardSlash, colon)
            delineator = (delineator > 0) ? delineator : Math.max(forwardSlash, colon)
            let word = entry.slice(0, delineator).trim()
            let wordData = entry.slice(delineator).trim()
            if (!dictionary[word]) {
                dictionary[word] = [wordData]
            } else {
                dictionary[word].push(wordData)
            }
        }
        
        if (url.includes('?')) {
            var queryTerm = decodeURI(url.slice(url.indexOf('?') + 1))
            sendEntry(queryTerm, dictionary[queryTerm])
        } else {

        }
    }
}

function sendEntry(term, associatedInfo) {
    let allEntries = []
    for (let entry of associatedInfo) {
        let subheadings = []
        entry = entry.split(':')
        let pronunciation = entry[0].trim()
        for (let i = 1; i < entry.length; i++) {
			let translations = []
            let subheading = entry[i].trim()
            
            if (subheading.startsWith("ET")) {
			
                subheading = '<h2>Etymology</h2><p>' + subheading.slice(subheading.indexOf('ET') + 2).trim()
                subheadings.push(subheading)
                
            } else if (subheading.startsWith('DT')) {
                
            } else {
                let senses = subheading.split('=')
                var pos = senses[0].trim()
                var translation = ''
                for (let j = 1; j < senses.length; j++) {
                    let sense = senses[j]
                    sense = sense.split('*')
                    var translation = '<li>' + sense[0].trim() + '</li>'
                    let quotes = ''
                    for (let k = 1; k < sense.length; k++) {
                        quotes = quotes + "<li>" + sense[k].trim() + '</li>'
                    }
                    if (quotes != "") quotes = '<ul>' + quotes + '</ul>'
                    translation = translation + quotes
	                translations.push(translation)
                }
                
                if (translation != []) translation = '<ol>' + translations.join("") + '</ol>'
                subheading = '<h3>' + pos + '</h3>' + translation
                subheadings.push(subheading)
            }
        }
        var final = '<h1>' + term + '</h1>' + '<p>' + pronunciation + '</p>' + subheadings.join('')
        allEntries.push(final)
    }
    document.getElementById('entry').innerHTML = allEntries.join('')

}

function searchWord() {
    let queryTerm = document.getElementById('search-box-input').value.trim()
	sendEntry(queryTerm, dictionary[queryTerm])
    var stateObj = { foo: 'bar' }
    history.pushState(stateObj, queryTerm, '?' + queryTerm)
}

let input = document.getElementById('search-box-input')
input.addEventListener('keyup', function(event) {
    if (event.keyCode === 13) {
        event.preventDefault()
        document.getElementById('magnifying-glass').click()
    }
})
   
</script>
    
</html>
